# Guia Completo de Deploy - Vercel + AlwaysData

## üöÄ Tutorial Passo a Passo para Deploy no Vercel com Database AlwaysData

### üìã Arquitetura da Solu√ß√£o

- **Frontend + Backend**: Vercel (hosting gratuito com dom√≠nio)
- **Database**: AlwaysData MySQL (j√° configurado)
- **Vantagens**: Deploy autom√°tico, SSL gratuito, CDN global, escalabilidade

---

## ‚úÖ PROBLEMAS RESOLVIDOS

### Problemas Identificados e Solu√ß√µes Aplicadas:

1. **‚ùå 404 Errors nas APIs**: Configura√ß√£o incorreta do vercel.json
   - ‚úÖ **Resolvido**: Atualizado vercel.json com estrutura correta de monorepo

2. **‚ùå URLs hardcodadas**: Frontend usava localhost:4000 em produ√ß√£o
   - ‚úÖ **Resolvido**: Criado sistema de configura√ß√£o de API baseado em ambiente

3. **‚ùå CORS Issues**: Backend n√£o permitia requests do dom√≠nio de produ√ß√£o
   - ‚úÖ **Resolvido**: Configurado CORS para m√∫ltiplos dom√≠nios Vercel

---

## üîß FASE 1: Arquivos de Configura√ß√£o (‚úÖ J√Å ATUALIZADOS)

### 1.1 vercel.json (Root do Projeto) - ‚úÖ ATUALIZADO

O arquivo `vercel.json` foi configurado para:
- Build do frontend na pasta `frontend/`
- Fun√ß√£o serverless para API em `api/index.js`
- Roteamento correto para `/api/*` e arquivos est√°ticos

### 1.2 API Configuration - ‚úÖ CRIADO

Criado `frontend/src/config/api.js` para:
- Detec√ß√£o autom√°tica de ambiente (dev/prod)
- URLs relativas em produ√ß√£o
- URLs absolutas em desenvolvimento

### 1.3 Environment Variables - ‚úÖ CONFIGURADO

Criados arquivos de ambiente:
- `.env.production` - Vari√°veis de produ√ß√£o
- `frontend/.env.development` - Frontend desenvolvimento
- `frontend/.env.production` - Frontend produ√ß√£o

---

## üåê FASE 2: Deploy no Vercel

### 2.1 Configura√ß√£o no Dashboard Vercel

1. **Acesse** [vercel.com](https://vercel.com) e fa√ßa login
2. **Clique** em "Add New" ‚Üí "Project"
3. **Importe** seu reposit√≥rio GitHub
4. **Configure** as seguintes op√ß√µes:

**Framework Preset**: Other
**Root Directory**: `./` (deixe vazio)
**Build Command**: `cd frontend && npm run build`
**Output Directory**: `frontend/dist`
**Install Command**: `cd frontend && npm ci`

### 2.2 Environment Variables no Vercel

**‚ö†Ô∏è IMPORTANTE**: Configure estas vari√°veis no Vercel Dashboard:

```
DB_HOST=mysql-johann.alwaysdata.net
DB_USER=johann
DB_PASSWORD=Johann@08022008
DB_NAME=johann_shophere_db
DB_PORT=3306
NODE_ENV=production
JWT_SECRET=your_super_secure_jwt_secret_for_production_change_this
```

**Como configurar**:
1. No Vercel Dashboard ‚Üí Seu projeto ‚Üí Settings ‚Üí Environment Variables
2. Adicione cada vari√°vel uma por vez
3. Marque todas as op√ß√µes: Production, Preview, Development

---

## üîç FASE 3: Verifica√ß√£o e Troubleshooting

### 3.1 URLs para Testar

Depois do deploy, teste estas URLs:

**Frontend**:
- `https://seu-projeto.vercel.app/` - P√°gina inicial
- `https://seu-projeto.vercel.app/login` - Login

**API Endpoints**:
- `https://seu-projeto.vercel.app/api/` - Health check
- `https://seu-projeto.vercel.app/api/categories` - Listar categorias
- `https://seu-projeto.vercel.app/api/products` - Listar produtos

### 3.2 Verificar Logs

No Vercel Dashboard:
1. **Functions** ‚Üí Clique na fun√ß√£o API
2. **View Logs** para ver erros em tempo real
3. **Invocations** para ver hist√≥rico de chamadas

### 3.3 Problemas Comuns e Solu√ß√µes

**‚ùå "Module not found"**:
```bash
# Re-deploy for√ßando reinstala√ß√£o
cd frontend && rm -rf node_modules package-lock.json && npm install
```

**‚ùå "Database connection failed"**:
- Verifique as Environment Variables no Vercel
- Teste conex√£o AlwaysData no painel deles

**‚ùå "CORS errors"**:
- Adicionado suporte autom√°tico para dom√≠nios *.vercel.app
- Configure FRONTEND_URL se usar dom√≠nio customizado

---
  "builds": [
    {
      "src": "frontend/package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "dist"
      }
    },
    {
      "src": "backend/src/index.js",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/backend/src/index.js"
    },
    {
      "src": "/(.*)",
      "dest": "/frontend/dist/$1"
    }
  ],
  "functions": {
    "backend/src/index.js": {
      "maxDuration": 30
    }
  }
}
```

### 1.3 Criar Arquivo api/index.js (Para Vercel Functions)

Vamos criar um ponto de entrada para as fun√ß√µes Vercel:

```javascript
// api/index.js
const express = require("express");
const cors = require("cors");
const dotenv = require("dotenv");
const path = require("path");

// Importar todas as rotas do backend
const authRoutes = require("../backend/src/routes/authRoutes");
const productRoutes = require("../backend/src/routes/productRoutes");
const categoryRoutes = require("../backend/src/routes/categoryRoutes");
const commerceRoutes = require("../backend/src/routes/commerceRoutes");
const uploadRoutes = require("../backend/src/routes/uploadRoutes");
const avaliacoesRouter = require("../backend/src/routes/avaliacaoProduto.routes");

dotenv.config();

const app = express();

// Middlewares
app.use(
  cors({
    origin: [
      process.env.FRONTEND_URL || "http://localhost:5173",
      "https://shophere-production.vercel.app",
      "https://*.vercel.app",
    ],
    credentials: true,
  })
);

app.use(express.json());

// Rotas da API
app.use("/api/auth", authRoutes);
app.use("/api/products", productRoutes);
app.use("/api/categories", categoryRoutes);
app.use("/api/commerces", commerceRoutes);
app.use("/api/upload", uploadRoutes);
app.use("/api/avaliacoes", avaliacoesRouter);

// Health check
app.get("/api/health", (req, res) => {
  res.json({
    status: "OK",
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV,
  });
});

// Rota raiz da API
app.get("/api", (req, res) => {
  res.json({
    message: "Shophere API rodando no Vercel!",
    version: "1.0.0",
  });
});

module.exports = app;
```

---

## üöÄ FASE 4: Deploy Final

### 4.1 Comandos para Re-deploy

Se precisar fazer re-deploy:

```bash
# Commit e push das altera√ß√µes
git add .
git commit -m "Fix: Updated API configuration for production"
git push origin main
```

O Vercel far√° deploy autom√°tico a cada push.

### 4.2 Testar Todas as Funcionalidades

**Checklist de Testes**:
- [ ] P√°gina inicial carrega
- [ ] Login/Signup funcionam
- [ ] Listar produtos funciona
- [ ] Criar produto funciona (seller)
- [ ] Upload de imagem funciona
- [ ] Avalia√ß√µes funcionam

---

## üìö RESUMO DAS ALTERA√á√ïES FEITAS

### ‚úÖ Arquivos Modificados

1. **`vercel.json`** - Configura√ß√£o para monorepo
2. **`frontend/src/config/api.js`** - Sistema de URLs din√¢micas
3. **`backend/src/index.js`** - CORS para produ√ß√£o
4. **M√∫ltiplos componentes** - Substitui√ß√£o de URLs hardcodadas

### ‚úÖ Novos Arquivos

1. **`.env.production`** - Vari√°veis de produ√ß√£o
2. **`frontend/.env.development`** - Frontend dev
3. **`frontend/.env.production`** - Frontend prod

---

## üÜò TROUBLESHOOTING

### Erro 404 nas APIs

**Sintoma**: APIs retornam 404
**Causa**: Configura√ß√£o incorreta do vercel.json
**Solu√ß√£o**: ‚úÖ Resolvido com nova configura√ß√£o

### Erro CORS

**Sintoma**: "CORS policy" no console
**Causa**: Backend n√£o permite origin do Vercel
**Solu√ß√£o**: ‚úÖ Resolvido com CORS din√¢mico

### URLs Hardcodadas

**Sintoma**: Requests para localhost:4000
**Causa**: URLs absolutas no c√≥digo
**Solu√ß√£o**: ‚úÖ Resolvido com API_CONFIG

---

## üéØ PR√ìXIMOS PASSOS

1. **Configure as environment variables no Vercel Dashboard**
2. **Fa√ßa push do c√≥digo atualizado**
3. **Aguarde o deploy autom√°tico**
4. **Teste todas as funcionalidades**

**Links Importantes**:
- Vercel Dashboard: https://vercel.com/dashboard
- Logs da aplica√ß√£o: No dashboard ‚Üí Functions ‚Üí View Logs
- AlwaysData: https://admin.alwaysdata.com/

### 2.3 Vari√°veis de Ambiente

No painel Vercel, configure estas vari√°veis:

```env
# Database AlwaysData
NODE_ENV=production
DB_HOST=mysql-johann.alwaysdata.net
DB_USER=johann
DB_PASSWORD=Johann@08022008
DB_NAME=johann_shophere_db
DB_PORT=3306

# URLs
FRONTEND_URL=https://shophere-production.vercel.app
BACKEND_URL=https://shophere-production.vercel.app/api

# JWT Secret
JWT_SECRET=seu_jwt_secret_super_seguro_para_producao_123456789

# Upload settings
UPLOAD_DIR=/tmp/uploads/
MAX_FILE_SIZE=5242880

# CORS
CORS_ORIGIN=https://shophere-production.vercel.app,https://*.vercel.app
```

---

## üìÅ FASE 3: Estrutura de Arquivos para Vercel

### 3.1 Atualizar vercel.json (vers√£o otimizada)

```json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "frontend/dist"
      }
    }
  ],
  "functions": {
    "api/*.js": {
      "runtime": "nodejs18.x",
      "maxDuration": 30
    }
  },
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/api/index.js"
    },
    {
      "src": "/(.*)",
      "dest": "/frontend/dist/$1"
    }
  ],
  "outputDirectory": "frontend/dist"
}
```

### 3.2 Criar package.json na raiz (para Vercel)

```json
{
  "name": "shophere-vercel",
  "version": "1.0.0",
  "scripts": {
    "build": "cd frontend && npm install && npm run build",
    "install-all": "npm install && cd frontend && npm install && cd ../backend && npm install"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "mysql2": "^3.6.1",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "multer": "^1.4.5-lts.1",
    "socket.io": "^4.7.2"
  }
}
```

---

## üîÑ FASE 4: Configura√ß√£o de CORS e APIs

### 4.1 Atualizar Backend para Vercel

Editar `backend/src/index.js`:

```javascript
// Configura√ß√£o CORS para Vercel
app.use(
  cors({
    origin: [
      process.env.FRONTEND_URL,
      "https://shophere-production.vercel.app",
      "https://*.vercel.app",
      "http://localhost:5173", // Para desenvolvimento
    ],
    credentials: true,
  })
);

// Para Vercel, usar porta do environment
const PORT = process.env.PORT || 4000;

// N√£o chamar app.listen() no Vercel (serverless)
if (process.env.NODE_ENV !== "production") {
  app.listen(PORT, () => {
    console.log(`Servidor rodando: http://localhost:${PORT}`);
  });
}

module.exports = app; // Importante para Vercel
```

### 4.2 Configurar Frontend para APIs do Vercel

Criar `frontend/src/config/api.js`:

```javascript
// Configura√ß√£o da API baseada no ambiente
const API_BASE_URL = import.meta.env.PROD
  ? "https://shophere-production.vercel.app/api"
  : "http://localhost:4000/api";

export const apiConfig = {
  baseURL: API_BASE_URL,
  timeout: 10000,
  headers: {
    "Content-Type": "application/json",
  },
};

// Exemplo de uso no frontend
export const api = {
  get: (url) => fetch(`${API_BASE_URL}${url}`),
  post: (url, data) =>
    fetch(`${API_BASE_URL}${url}`, {
      method: "POST",
      headers: apiConfig.headers,
      body: JSON.stringify(data),
    }),
};
```

---

## üöÄ FASE 5: Deploy e Teste

### 5.1 Fazer Deploy

1. **Push para GitHub**:

   ```bash
   git add .
   git commit -m "Configure for Vercel deployment"
   git push origin main
   ```

2. **Deploy Autom√°tico**: Vercel detectar√° automaticamente

3. **Monitorar Deploy**: Acompanhe o progresso no dashboard

### 5.2 Verificar URLs

Ap√≥s deploy bem-sucedido:

- **Frontend**: https://shophere-production.vercel.app
- **API**: https://shophere-production.vercel.app/api
- **Health Check**: https://shophere-production.vercel.app/api/health

---

## üîß FASE 6: Troubleshooting

### 6.1 Problemas Comuns

**Erro de Build**:

```bash
# Verificar se os scripts est√£o corretos
npm run build # deve funcionar localmente
```

**Erro de Database**:

```bash
# Testar conex√£o
curl https://shophere-production.vercel.app/api/health
```

**CORS Errors**:

```javascript
// Verificar se o CORS est√° configurado para o dom√≠nio Vercel
origin: ["https://shophere-production.vercel.app"];
```

### 6.2 Logs e Debugging

1. **Vercel Dashboard**: Functions ‚Üí View Function Logs
2. **Real-time Logs**: `vercel logs shophere-production`
3. **Local Testing**: `vercel dev`

---

## üìä FASE 7: Monitoramento e Performance

### 7.1 Analytics

- **Vercel Analytics**: Ativar no dashboard
- **Web Vitals**: Monitorar performance
- **Function Metrics**: Tempo de execu√ß√£o das APIs

### 7.2 Otimiza√ß√µes

1. **Edge Functions**: Para melhor performance global
2. **Caching**: Configurar cache headers
3. **Compression**: Gzip autom√°tico no Vercel

---

## ‚úÖ Checklist Final

### Pr√©-Deploy

- [ ] vercel.json configurado
- [ ] api/index.js criado
- [ ] package.json na raiz
- [ ] Vari√°veis de ambiente definidas

### Deploy

- [ ] Reposit√≥rio conectado no Vercel
- [ ] Build command correto
- [ ] Environment variables configuradas
- [ ] Deploy bem-sucedido

### P√≥s-Deploy

- [ ] Frontend carregando
- [ ] API respondendo (/api/health)
- [ ] Database conectando
- [ ] CORS funcionando
- [ ] Upload de arquivos (se aplic√°vel)

### Produ√ß√£o

- [ ] Custom domain (opcional)
- [ ] SSL ativo (autom√°tico)
- [ ] Analytics configurado
- [ ] Backup de database

---

## üéâ URLs Finais

**Frontend**: https://shophere-production.vercel.app
**API**: https://shophere-production.vercel.app/api
**Database**: mysql-johann.alwaysdata.net (AlwaysData)

**Benef√≠cios desta arquitetura**:

- ‚úÖ Deploy autom√°tico via Git
- ‚úÖ SSL gratuito
- ‚úÖ CDN global
- ‚úÖ Escalabilidade autom√°tica
- ‚úÖ Database persistente no AlwaysData
- ‚úÖ Zero downtime deployments
